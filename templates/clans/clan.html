<#include "/assets/base.html">
<div class="container">
    <!-- Mode Selector Card -->
    <div class="card">
        <div class="row m-2 m-lg-0 shiina-def-cursor justify-content-center justify-content-lg-start">
            <#include "/freemarker/selector.ftl">
            <#include "/freemarker/rx-selector.ftl">
        </div>
    </div>

    <!-- Main Clan Profile Card -->
    <div class="card rounded my-4">
        <!-- Hero Section -->
        <div class="bg-gradient rounded position-relative"
             style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="row p-4 position-relative">
                <!-- Clan Avatar/Collage -->
                <div class="col-12 col-md-3 d-flex justify-content-center align-items-center mb-3 mb-md-0">
                    <div class="position-relative">
                        <div class="user-collage user-collage-lg rounded overflow-hidden"
                             style="width: 150px; height: 150px;">
                            <#assign count=0>
                            <img src="${avatarServer}/${clan.owner?c}" class="w-100 h-100 object-fit-cover" alt="Owner">
                            <#list members as collage>
                                <#assign count=count + 1>
                                <img src="${avatarServer}/${collage.id?c}" class="w-100 h-100 object-fit-cover" alt="Member">
                                <#if count==3><#break></#if>
                            </#list>
                            <#if count==0>
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                            <#elseif count==1>
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                            <#elseif count==2>
                                <img src="${avatarServer}/0" class="w-100 h-100 object-fit-cover" alt="Default">
                            </#if>
                        </div>
                    </div>
                </div>
                
                <!-- Clan Info -->
                <div class="col-12 col-md-9 d-flex flex-column justify-content-center text-white" >
                    <div class="mb-2">
                        <h1 class="display-4 fw-bold mb-2 shiina-player-name">${clan.name}</h1>
                    </div>
                    
                    <!-- Owner Info -->
                     <#assign u={ "id" : clan.owner, "name" : clan.ownerName, "country" :
                                clan.ownerCountry, "isOwner" : true }>
                                <#assign index=0>
                                    <#include "/freemarker/models/user.ftl">
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="card-body bg-body">
            <!-- Clan Actions -->
            <div class="d-flex flex-wrap gap-2 mx-1 mb-4">
                <#if clanRel??>
                    <#if clan.owner==user.id>
                        <a href="/clan/${clan.id}/settings" class="btn btn-secondary">
                            <i class="fa-solid fa-gear me-2"></i>Clan Management
                        </a>
                    </#if>
                    
                    <#if clanRel.userInThisClan>
                        <span class="shiina-follower-count">
                            <div class="shiina-follower-count-icon">
                                <i class="fa-solid fa-heart-circle-check"></i>
                            </div>
                            <div class="shiina-follower-count-body">
                                Member
                            </div>
                        </span>
                    <#elseif clanRel.clanIdCheck>
                        <button type="button" class="btn btn-secondary disabled" data-bs-toggle="tooltip" 
                                title="You are already in a clan">Request joining</button>
                    <#elseif clanRel.inShClanPending>
                        <button type="button" class="btn btn-warning" 
                                onclick="handleClanJoinRequest('${clan.id}', 'REVOKE')">
                            <i class="fas fa-clock me-1"></i>Revoke request
                        </button>
                    <#elseif clanRel.inShClanDenied>
                        <span class="shiina-follower-count">
                            <div class="shiina-follower-count-icon">
                                <i class="fa-solid fa-shield text-danger"></i>
                            </div>
                            <div class="shiina-follower-count-body">
                                Denied from joining
                            </div>
                        </span>
                    <#else>
                        <button type="button" class="btn btn-success" 
                                onclick="handleClanJoinRequest('${clan.id}', 'REQUEST')">
                            <i class="fas fa-user-plus me-1"></i>Request joining
                        </button>
                    </#if>
                    
                    <#if clan.owner==user.id>
                        <span class="shiina-follower-count">
                            <div class="shiina-follower-count-icon">
                                <i class="fa-solid fa-shield text-primary"></i>
                            </div>
                            <div class="shiina-follower-count-body">
                                Owner
                            </div>
                        </span>
                    </#if>
                    
                    <span class="shiina-follower-count">
                        <div class="shiina-follower-count-icon">
                            <i class="fa-solid fa-hashtag"></i>
                        </div>
                        <div class="shiina-follower-count-body">
                            [${clan.tag}]
                        </div>
                    </span>
                <#else>
                    <span class="shiina-follower-count">
                        <div class="shiina-follower-count-icon">
                            <i class="fa-solid fa-hashtag"></i>
                        </div>
                        <div class="shiina-follower-count-body">
                            [${clan.tag}]
                        </div>
                    </span>
                </#if>
            </div>

            <!-- Stats Grid -->
            <div class="row mb-4">
                <div class="col col-12 col-sm-12 col-lg-6">
                    <div class="row p-3 mx-1 h-100 border rounded" style="background: rgba(0,0,0,0.1);">
                        <div class="col col-12 col-md-6">
                            <small>Total PP Rank</small>
                            <h2>#${clan.totalPPRank}</h2>
                        </div>
                        <div class="col col-12 col-md-6">
                            <small>Average PP Rank</small>
                            <h2>#${clan.avgPPRank}</h2>
                        </div>
                        <div class="col col-12 col-md-6">
                            <small>Ranked Score Rank</small>
                            <h2>#${clan.rankedScoreRank}</h2>
                        </div>
                        <div class="col col-12 col-md-6">
                            <small>Accuracy Rank</small>
                            <h2>#${clan.accRank}</h2>
                        </div>
                    </div>
                </div>
                <div class="col col-12 col-sm-12 col-lg-6 mt-2 mt-lg-0">
                    <div class="p-3 mx-1 border rounded h-100" style="background: rgba(0,0,0,0.1);">
                        <table class="w-100">
                            <tbody>
                                <tr>
                                    <td>Clan created:</td>
                                    <td data-timestamp-format="date" data-timestamp="${clan.created}">${clan.created}</td>
                                </tr>
                                <tr>
                                    <td>Owner last active:</td>
                                    <td data-timestamp-format="unix" data-timestamp="${clan.ownerLastActivity?c}">${clan.ownerLastActivity?c}</td>
                                </tr>
                                <tr>
                                    <td>Members:</td>
                                    <td>${clan.members}</td>
                                </tr>
                                <tr>
                                    <td>Total PP:</td>
                                    <td>${clan.totalPP}</td>
                                </tr>
                                <tr>
                                    <td>Average PP:</td>
                                    <td>${clan.avgPP}</td>
                                </tr>
                                <tr>
                                    <td>Ranked Score:</td>
                                    <td>${clan.rankedScore}</td>
                                </tr>
                                <tr>
                                    <td>Accuracy:</td>
                                    <td>${clan.acc}%</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div class="card mx-1 mb-4" style="background: rgba(0,0,0,0.1);">
                <div class="card-body p-0">
                    <div class="row mt-2 mx-0">
                        <#list members as u>
                            <#assign index=u?index>
                            <div class="col-12 mb-2 col-md-6 member-entry <#if (index >= 4)>d-none</#if>">
                                <a href="/u/${u.id?c}<#if u.mode??>?mode=${u.mode}</#if>"
                                   class="d-block border p-3 text-decoration-none text-reset"
                                   style="transition: all 0.15s ease-in-out; border-radius: 0.375rem;"
                                   onmouseover="this.style.backgroundColor='hsla(var(--bs-white-hsl), 0.05)'; this.style.transform='translateY(-1px)';"
                                   onmouseout="this.style.backgroundColor='transparent'; this.style.transform='translateY(0)';">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            <img src="${avatarServer}/${u.id?c}" alt="${u.name}" class="rounded" width="40" height="40">
                                        </div>
                                        <#if u.country??>
                                        <div class="me-3 d-none d-md-block">
                                            <img src="/img/flags/${u.country}.svg" alt="${u.country}" class="rounded" width="24" height="18">
                                        </div>
                                        </#if>
                                        <div class="flex-grow-1">
                                            <div class="fw-bold text-body">${u.name}</div>
                                        </div>
                                        <div class="text-end">
                                            <small class="text-muted" data-timestamp-format="unix" data-timestamp="${u.latestActivity?c}">
                                                ${u.latestActivity?c}
                                            </small>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        <#else>
                            <div class="col-12 text-center py-5">
                                <h5 class="text-muted">No members in this clan.</h5>
                            </div>
                        </#list>
                           <#if (members?size > 4)>
                    <button id="loadMoreBtn" class="btn rounded-top-0 btn-sm btn-outline-secondary">Load More Members</button>
                        </#if>
                    </div>
                </div>
             
            </div>

            <!-- Activity Section -->
            <div class="card mx-1" style="background: rgba(0,0,0,0.1);">
                <div class="card-body row p-0 m-0" id="activity">
      
                        <#list activity as score>
                            <#assign index=score?index>
                            <#assign isActivity=true>
                            <#include "/freemarker/models/score.ftl">
                        </#list>
                           <#if (activity?size > 4)>
                    <button id="loadMoreBtnAct" class="btn rounded-top-0 btn-sm btn-outline-secondary">Load More Activity</button>
                </#if>
            
                    
                </div>
             
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="currentCount" value="4">
<input type="hidden" id="totalMembers" value="${members?size}">
<input type="hidden" id="currentCountAct" value="4">
<input type="hidden" id="totalMembersAct" value="${activity?size}">

<#include "/assets/footer.html">
<script>
    var loadMoreBtn = document.getElementById('loadMoreBtn');
    var loadMoreBtnAct = document.getElementById('loadMoreBtnAct');

    var loadMoreBtnHandler = null;
    var loadMoreBtnActHandler = null;

    function loadMoreHandler(isActivity) {
        let currentCountName = isActivity ? 'currentCountAct' : 'currentCount';
        let totalMembersName = isActivity ? 'totalMembersAct' : 'totalMembers';
        let entryName = isActivity ? 'act' : 'member';

        let currentCount = parseInt(document.getElementById(currentCountName).value, 10);
        let totalMembers = parseInt(document.getElementById(totalMembersName).value, 10);

        const hiddenEntries = document.querySelectorAll('.' + entryName + '-entry.d-none');
        const limit = Math.min(hiddenEntries.length, 4);

        for (let i = 0; i < limit; i++) {
            hiddenEntries[i].classList.remove('d-none');
        }

        currentCount += limit;
        document.getElementById(currentCountName).value = currentCount;

        if (currentCount >= totalMembers || hiddenEntries.length === 0) {
            if (isActivity) {
                loadMoreBtnAct.style.display = 'none';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }
    }

    function initLoadMoreButtons() {
        cleanupLoadMoreButtons();

        if (loadMoreBtn) {
            loadMoreBtnHandler = () => loadMoreHandler(false);
            loadMoreBtn.addEventListener('click', loadMoreBtnHandler);
        }

        if (loadMoreBtnAct) {
            loadMoreBtnActHandler = () => loadMoreHandler(true);
            loadMoreBtnAct.addEventListener('click', loadMoreBtnActHandler);
        }
    }

    function cleanupLoadMoreButtons() {
        if (loadMoreBtn && loadMoreBtnHandler) {
            loadMoreBtn.removeEventListener('click', loadMoreBtnHandler);
            loadMoreBtnHandler = null;
        }

        if (loadMoreBtnAct && loadMoreBtnActHandler) {
            loadMoreBtnAct.removeEventListener('click', loadMoreBtnActHandler);
            loadMoreBtnActHandler = null;
        }
    }

    document.addEventListener('turbo:load', initLoadMoreButtons);
    document.addEventListener('turbo:before-cache', cleanupLoadMoreButtons);
</script>
